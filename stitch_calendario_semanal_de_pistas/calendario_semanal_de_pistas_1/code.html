<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Calendario Pistas Padel</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec80",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
    <div class="relative flex flex-col h-screen w-full max-w-md mx-auto bg-background-light dark:bg-background-dark shadow-2xl overflow-hidden">
        <main class="flex-1 overflow-y-auto overflow-x-hidden pb-24">
            <div class="px-4 mt-4">
                <h3 class="text-xl font-bold">Horarios Disponibles</h3>
                <div id="time-slots-container" class="flex flex-col gap-3 mt-4">
                    <!-- Los horarios se cargarán aquí dinámicamente -->
                </div>
            </div>
        </main>
    </div>

    <script src="../assets/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const timeSlotsContainer = document.getElementById('time-slots-container');

            async function loadSchedule() {
                try {
                    const [courtsRes, scheduleRes] = await Promise.all([
                        fetch('/api/courts'),
                        fetch('/api/schedule')
                    ]);

                    if (!courtsRes.ok || !scheduleRes.ok) {
                       throw new Error('Error al cargar los datos del calendario.');
                    }

                    const courts = await courtsRes.json();
                    const schedule = await scheduleRes.json();

                    renderTimeSlots(courts, schedule);

                } catch (error) {
                    timeSlotsContainer.innerHTML = `<p class="text-red-500">${error.message}</p>`;
                }
            }

            function renderTimeSlots(courts, schedule) {
                timeSlotsContainer.innerHTML = '';

                const slots = ["09:00", "10:30", "12:00", "13:30", "15:00", "16:30", "18:00", "19:30"];
                const today = new Date().toISOString().slice(0, 10);

                courts.forEach(court => {
                    slots.forEach(slot => {
                        const startTime = `${today}T${slot}:00.000Z`;

                        const isReserved = schedule.some(res =>
                            res.court_id === court.id && new Date(res.start_time).toISOString() === startTime
                        );

                        const slotElement = document.createElement('div');
                        slotElement.className = `p-4 rounded-xl border ${isReserved ? 'bg-gray-100 border-gray-200' : 'bg-white border-gray-300'}`;

                        slotElement.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold">${court.name} - ${slot}</h4>
                                    <p class="text-sm text-gray-500">${court.type}</p>
                                </div>
                                ${!isReserved ? `<button data-court-id="${court.id}" data-start-time="${startTime}" class="reserve-button bg-primary text-black font-bold py-2 px-4 rounded">Reservar</button>` : '<span class="text-red-500 font-bold">Ocupado</span>'}
                            </div>
                        `;
                        timeSlotsContainer.appendChild(slotElement);
                    });
                });
            }

            timeSlotsContainer.addEventListener('click', async (event) => {
                if (event.target.classList.contains('reserve-button')) {
                    const button = event.target;
                    const courtId = button.dataset.courtId;
                    const startTime = button.dataset.startTime; // This is now just for identification

                    const today = new Date().toISOString().slice(0, 10);
                    const slot = new Date(startTime).getUTCHours() + ':' + ('0' + new Date(startTime).getUTCMinutes()).slice(-2);


                    try {
                        const response = await fetch('/api/reservations', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                court_id: parseInt(courtId),
                                date: today,
                                slot: slot
                            })
                        });

                        if (response.ok) {
                            alert('¡Reserva creada con éxito!');
                            loadSchedule();
                        } else {
                            if (response.status === 401 || response.status === 403) {
                                alert('Debes iniciar sesión para reservar.');
                                window.location.href = '/inicio_de_sesion/code.html';
                            } else {
                                const data = await response.json();
                                alert(`Error: ${data.error || 'No se pudo crear la reserva.'}`);
                            }
                        }
                    } catch (error) {
                        alert('Error de conexión al intentar reservar.');
                    }
                }
            });

            loadSchedule();
        });
    </script>
</body>
</html>
